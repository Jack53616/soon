# QL Trading AI v3.0 - سجل التعديلات

## الملفات المعدلة (14 ملف)

| الملف | نوع التعديل | الوصف |
|-------|-------------|-------|
| `server/bot/bot.js` | تعديل | إضافة نظام الدعوات، فحص الحظر عند /start |
| `server/controllers/admin.controller.js` | تعديل | إضافة الصفقات الجماعية، إحصائيات الدعوات، إصلاح البث |
| `server/controllers/auth.controller.js` | تعديل | إضافة معالجة الدعوات، فحص الحظر |
| `server/controllers/wallet.controller.js` | تعديل | إضافة معالج الإيداع مع مكافأة الدعوة |
| `server/routes/admin.routes.js` | تعديل | إضافة مسارات الصفقات الجماعية والدعوات |
| `server/routes/auth.routes.js` | تعديل | إضافة مسار معلومات الدعوة |
| `server/routes/wallet.routes.js` | تعديل | إضافة مسار الإيداع |
| `client/admin.html` | تعديل | إضافة تبويبات الصفقات الجماعية والدعوات |
| `client/admin.js` | تعديل | إضافة واجهة إدارة الصفقات الجماعية والدعوات |
| `client/app.js` | تعديل | إضافة شاشة الحظر وفحص الحظر |
| `client/index.html` | تعديل | إضافة HTML شاشة الحظر |
| `client/style.css` | تعديل | إضافة أنماط شاشة الحظر |
| `db_migration_v3.0.sql` | جديد | ملف migration لقاعدة البيانات |
| `package.json` | تعديل | تحديث النسخة إلى 3.0.0 |

---

## 1. نظام الدعوات (Referral System)

### كيف يعمل:
- كل مستخدم يحصل على **رابط دعوة فريد** عند التسجيل
- الرابط بصيغة: `https://t.me/BOT_USERNAME?start=ref_XXXXXXXX`
- عندما يدخل شخص عبر الرابط ويسجل في البوت، يتم تسجيل الدعوة
- **المكافآت تُحسب عند الإيداع:**
  - إيداع **$500 - $999** → مكافأة **$50** للداعي
  - إيداع **$1000+** → مكافأة **$100** للداعي
- المكافأة تُضاف تلقائياً لرصيد الداعي مع إشعار Telegram

### جداول قاعدة البيانات الجديدة:
- `referrals` - تتبع الدعوات
- أعمدة جديدة في `users`: `referred_by`, `referral_code`, `referral_earnings`

### في لوحة الأدمن:
- تبويب **الدعوات** يعرض إحصائيات شاملة
- أفضل 10 داعين مع عدد الدعوات والأرباح

---

## 2. إصلاح الرسائل الجماعية (Broadcast Fix)

### المشكلة:
- الرسائل كانت تُحفظ فقط في `system_messages` ولا تُرسل عبر Telegram

### الحل:
- الآن تُرسل الرسالة لجميع المستخدمين غير المحظورين عبر Telegram
- تُحفظ أيضاً في قاعدة البيانات
- يظهر عدد الرسائل المُرسلة بنجاح والفاشلة

---

## 3. إصلاح رسائل الصفقات من لوحة الأدمن

### المشكلة:
- فتح صفقة من لوحة الأدمن لم يكن يرسل إشعار للمستخدم

### الحل:
- إضافة إشعار Telegram عند فتح صفقة من لوحة الأدمن
- إضافة إشعار عند إغلاق صفقة من لوحة الأدمن

---

## 4. نظام حظر المستخدمين المحسّن

### الميزات:
- **شاشة حظر احترافية** تظهر للمستخدم المحظور مع:
  - أيقونة حظر متحركة
  - سبب الحظر
  - أزرار تواصل مع الدعم (Telegram + WhatsApp)
  - تصميم احترافي متوافق مع الثيم
- **فحص الحظر** في كل مكان:
  - عند `/start` في البوت
  - عند التسجيل (activate)
  - عند تحديث بيانات المستخدم (refreshUser)
- **رفع الحظر** من لوحة الأدمن مع إشعار للمستخدم
- إرسال رسالة Telegram عند الحظر مع سبب الحظر

### في لوحة الأدمن:
- زر **حظر** مع إدخال السبب
- زر **رفع الحظر** يظهر للمستخدمين المحظورين
- حالة الحظر تظهر بوضوح في تفاصيل المستخدم

---

## 5. نظام الصفقات الجماعية (Mass Trades)

### الميزات:
- **فتح صفقة جماعية** لجميع المستخدمين (غير المحظورين، رصيد > 0)
- **إغلاق الصفقة** بنسبة مئوية عامة (مثل +5% أو -3%)
- **الربح/الخسارة يُحسب كنسبة من رصيد كل مستخدم**
- **تحكم متقدم:** تحديد نسبة مختلفة لمستخدم معين
- **تحديث تلقائي** لأرصدة جميع المستخدمين عند الإغلاق
- **إشعارات Telegram** لكل مستخدم بالنتيجة
- **سجل كامل** لكل صفقة جماعية مع تفاصيل المشاركين

### جداول قاعدة البيانات الجديدة:
- `mass_trades` - الصفقات الجماعية
- `mass_trade_overrides` - النسب المخصصة لمستخدمين محددين
- `mass_trade_participants` - سجل المشاركين والنتائج

### في لوحة الأدمن:
- تبويب **صفقات جماعية** مع:
  - فتح صفقة جديدة (رمز، اتجاه، ملاحظة)
  - إغلاق صفقة بنسبة مئوية
  - تحديد نسبة مخصصة لمستخدم معين
  - عرض تفاصيل الصفقة والمشاركين
  - سجل جميع الصفقات الجماعية

---

## تعليمات التشغيل

### 1. تشغيل Migration:
```sql
-- شغّل هذا الملف على قاعدة البيانات قبل تشغيل النسخة الجديدة
\i db_migration_v3.0.sql
```

### 2. لا حاجة لتغيير متغيرات البيئة
جميع الميزات الجديدة تعمل مع نفس الإعدادات الحالية.

### 3. التحقق:
- تأكد من تشغيل migration قبل deploy
- اختبر نظام الدعوات بإرسال `/start ref_TESTCODE` للبوت
- اختبر الصفقات الجماعية من لوحة الأدمن
